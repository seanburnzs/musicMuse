{% extends "base.html" %}

{% block header_title %}Music Charts{% endblock %}

{% block content %}
<h2 class="music-question-header"><em class="emphasis-word">Chart</em> your listening trends over time.</h2>
<style>
  /* Header styling */
  .music-question-header {
    text-align: center;
    margin-bottom: 20px;
    color: #000;
    font-weight: 600;
    font-size: 1.5rem;
  }

  .music-question-header .emphasis-word {
    color: #6a5acd;
  }
  
  .charts-container {
    display: flex;
    flex-direction: row;
    gap: 20px;
    margin-top: 20px;
  }
  
  /* Chart Controls Sidebar */
  .chart-sidebar {
    width: 280px;
    flex-shrink: 0;
    background-color: #f8f9fa;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
    height: fit-content;
    position: sticky;
    top: 20px;
  }
  
  .sidebar-section {
    margin-bottom: 25px;
  }
  
  .sidebar-section h3 {
    font-size: 16px;
    margin-bottom: 15px;
    color: #333;
    font-weight: 600;
    border-bottom: 1px solid #e2e8f0;
    padding-bottom: 8px;
  }
  
  /* Form Controls */
  .form-group {
    margin-bottom: 15px;
  }
  
  .form-group label {
    display: block;
    font-weight: 500;
    margin-bottom: 6px;
    font-size: 14px;
    color: #4a5568;
  }
  
  .form-group select, .form-group input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    background-color: white;
  }
  
  /* Chart Display Area */
  .chart-main {
    flex: 1;
    min-width: 0; /* Prevent flexbox from overflowing */
  }
  
  .chart-wrapper {
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 20px;
    transition: background-color 0.3s ease;
  }
  
  .chart-wrapper.dark-mode {
    background-color: #121212;
    color: #e0e0e0;
  }
  
  .chart-canvas-container {
    height: 500px;
    width: 100%;
    position: relative;
    margin-bottom: 60px;
  }
  
  .chart-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 35px;
    gap: 10px;
    position: relative;
    z-index: 5;
  }
  
  .chart-download-btn, .chart-theme-btn {
    background-color: #4361ee;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.2s;
  }
  
  .chart-download-btn:hover, .chart-theme-btn:hover {
    background-color: #3a0ca3;
  }
  
  .chart-placeholder {
    text-align: center;
    padding: 60px 0;
    color: #666;
    font-style: italic;
  }
  
  /* Make legend items appear clickable */
  .chart-canvas-container ul li {
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s, transform 0.1s;
  }
  
  .chart-canvas-container ul li:hover {
    background-color: rgba(0, 0, 0, 0.05);
    transform: translateY(-1px);
  }
  
  .chart-wrapper.dark-mode .chart-canvas-container ul li:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  /* Style the instruction text */
  .chart-instruction {
    background-color: #f8f9fa;
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 15px;
    color: #666;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .chart-wrapper.dark-mode .chart-instruction {
    background-color: rgba(255, 255, 255, 0.1);
    color: #e0e0e0;
  }
  
  /* Colors customization panel */
  .colors-panel {
    margin-top: 25px;
    border-top: 1px solid #e2e8f0;
    padding-top: 20px;
  }
  
  .colors-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .colors-panel-header h3 {
    border-bottom: none !important;
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
  }
  
  .colors-panel-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .dataset-colors {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .dataset-color-item {
    display: flex;
    align-items: center;
    background-color: white;
    border-radius: 6px;
    padding: 8px 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .color-preview {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    margin-right: 10px;
    cursor: pointer;
    border: 1px solid #ddd;
  }
  
  .color-label {
    flex: 1;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .background-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  
  .bg-option {
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 3px solid transparent;
    transition: border-color 0.2s;
  }
  
  .bg-option.selected {
    border-color: #4361ee;
  }
  
  .bg-preview {
    width: 100%;
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-weight: 600;
    font-size: 14px;
  }
  
  .bg-light {
    background-color: #ffffff;
    color: #333333;
  }
  
  .bg-dark {
    background-color: #121212;
    color: #e0e0e0;
  }
  
  .bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  .bg-blue {
    background-color: #EFF6FF;
    color: #1E40AF;
  }
  
  .randomize-button {
    width: 100%;
    margin-bottom: 10px;
  }
  
  .generate-button {
    width: 100%;
    margin-top: 20px;
    padding: 10px;
    background-color: #4361ee;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .generate-button:hover {
    background-color: #3a0ca3;
  }
  
  /* Search results */
  .search-container {
    position: relative;
  }
  
  #item-search {
    max-width: 100%;
    width: 100%;
    box-sizing: border-box;
  }
  
  .search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    z-index: 10;
  }
  
  .search-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  
  .search-item:hover {
    background-color: #f5f5f5;
  }
  
  .search-item .item-name {
    font-weight: 500;
  }
  
  .search-item .item-artist {
    font-size: 12px;
    color: #666;
  }
  
  .no-results, .error {
    padding: 10px;
    text-align: center;
    color: #666;
  }
  
  /* Selected items */
  .selected-items {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 6px;
    background-color: #fff;
  }
  
  .no-items {
    padding: 15px;
    text-align: center;
    color: #666;
    font-style: italic;
  }
  
  .selected-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
  }
  
  .selected-item:last-child {
    border-bottom: none;
  }
  
  .remove-item {
    background: none;
    border: none;
    color: #e53e3e;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
  }
  
  .remove-item:hover {
    background-color: rgba(229, 62, 62, 0.1);
  }
  
  /* Loading spinner */
  #chart-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top-color: #4361ee;
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Responsive layout */
  @media (max-width: 900px) {
    .charts-container {
      flex-direction: column;
    }
    
    .chart-sidebar {
      width: 100%;
      position: static;
    }
  }
</style>

<div class="charts-container">
  <!-- Chart Controls Sidebar -->
  <div class="chart-sidebar">
    <div class="sidebar-section">
      <h3>Chart Options</h3>
      <div class="form-group">
        <label for="chart-type">Chart Type</label>
        <select id="chart-type">
          <option value="total">Total (Bar Graph)</option>
          <option value="progression">Progression (Line Graph)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="time-group">Group By</label>
        <select id="time-group">
          <option value="month">Month</option>
          <option value="year">Year</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="time-range">Time Range</label>
        <select id="time-range">
          <option value="all_time">All Time</option>
          <option value="last_7_days">Last 7 Days</option>
          <option value="last_30_days">Last 30 Days</option>
          <option value="last_90_days">Last 90 Days</option>
          <option value="last_365_days">Last Year</option>
          <option value="ytd">Year to Date</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      
      <div id="custom-date-range" class="form-group" style="display: none;">
        <label for="custom-start">Start Date</label>
        <input type="date" id="custom-start">
        <label for="custom-end">End Date</label>
        <input type="date" id="custom-end">
      </div>
    </div>
    
    <div class="sidebar-section">
      <h3>Data Selection</h3>
      <div class="form-group">
        <label for="item-type">Item Type</label>
        <select id="item-type">
          <option value="artists">Artists</option>
          <option value="albums">Albums</option>
          <option value="tracks">Tracks</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="chart-item-search">Search Items</label>
        <div class="search-container charts-search-container">
          <input type="text" id="chart-item-search" class="charts-item-search" placeholder="Search for items...">
          <div id="chart-search-results" class="search-results charts-search-results"></div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="selected-items">Selected Items</label>
        <div id="selected-items" class="selected-items">
          <p class="no-items">No items selected</p>
        </div>
      </div>
    </div>
    
    <div class="colors-panel">
      <div class="colors-panel-header">
        <h3>Appearance</h3>
      </div>
      <div class="colors-panel-content">
        <button id="randomize-colors" class="chart-theme-btn randomize-button">
          <i class="fas fa-random"></i> Randomize Colors
        </button>
        
        <h4>Item Colors</h4>
        <div id="dataset-colors" class="dataset-colors">
          <!-- Dataset color items will be added here dynamically -->
          <p class="no-items">Generate a chart to customize colors</p>
        </div>
        
        <h4>Background for Download</h4>
        <div class="background-options">
          <div class="bg-option selected" data-bg="light">
            <div class="bg-preview bg-light">Light</div>
          </div>
          <div class="bg-option" data-bg="dark">
            <div class="bg-preview bg-dark">Dark</div>
          </div>
          <div class="bg-option" data-bg="gradient">
            <div class="bg-preview bg-gradient">Gradient</div>
          </div>
          <div class="bg-option" data-bg="blue">
            <div class="bg-preview bg-blue">Blue</div>
          </div>
        </div>
      </div>
    </div>
    
    <button id="generate-chart" class="generate-button">Generate Chart</button>
  </div>
  
  <!-- Chart Display Area -->
  <div class="chart-main">
    <div id="chart-container" class="chart-wrapper">
      <p class="chart-placeholder">Select your chart options and click "Generate Chart" to visualize your music data</p>
    </div>
    <div id="chart-loading" style="display: none;">
      <div class="spinner"></div>
      <p>Generating chart...</p>
    </div>
  </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Charts Script -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Prevent chart search from conflicting with profile search
    const chartSearchInput = document.querySelector('#chart-item-search');
    const chartSearchContainer = document.querySelector('.charts-search-container');
    const chartSearchResults = document.querySelector('#chart-search-results');
    
    // Apply complete isolation for the chart search elements to prevent conflicts
    if (chartSearchInput) {
      // Stop propagation for all relevant events on the search input
      ['click', 'focus', 'input', 'keydown', 'keyup'].forEach(eventType => {
        chartSearchInput.addEventListener(eventType, function(e) {
          e.stopPropagation();
        });
      });
      
      // Similarly isolate the search container
      if (chartSearchContainer) {
        ['click', 'mousedown', 'mouseup', 'mousemove'].forEach(eventType => {
          chartSearchContainer.addEventListener(eventType, function(e) {
            e.stopPropagation();
          });
        });
      }
      
      // And the search results
      if (chartSearchResults) {
        ['click', 'mousedown', 'mouseup'].forEach(eventType => {
          chartSearchResults.addEventListener(eventType, function(e) {
            e.stopPropagation();
          });
        });
      }
    }
    
    // Set up variables
    const timeRangeSelect = document.getElementById('time-range');
    const customDateRange = document.getElementById('custom-date-range');
    const itemTypeSelect = document.getElementById('item-type');
    const itemSearchInput = document.getElementById('chart-item-search');
    const searchResults = document.getElementById('chart-search-results');
    const selectedItems = document.getElementById('selected-items');
    const generateButton = document.getElementById('generate-chart');
    const chartContainer = document.getElementById('chart-container');
    const chartLoading = document.getElementById('chart-loading');
    const randomizeColorsButton = document.getElementById('randomize-colors');
    
    // Current state
    const selectedItemsData = [];
    let chartInstance = null;
    
    // Initialize event listeners
    initEventListeners();
    
    function initEventListeners() {
      // Show custom date range if selected
      timeRangeSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
          customDateRange.style.display = 'block';
        } else {
          customDateRange.style.display = 'none';
        }
      });
      
      // Handle item search - with event stopPropagation to prevent conflict
      itemSearchInput.addEventListener('input', function(e) {
        // Prevent event bubbling to other handlers
        e.stopPropagation();
        
        // Ensure we're using the chart search input, not the profile search
        if (e.target !== itemSearchInput) {
          console.log("Search event coming from a different input, ignoring");
          return;
        }
        
        const query = this.value.trim();
        const itemType = itemTypeSelect.value;
        
        if (query.length < 2) {
          searchResults.innerHTML = '';
          return;
        }
        
        fetch(`/api/search_items?type=${itemType}&q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(data => {
            searchResults.innerHTML = '';
            
            if (data.items.length === 0) {
              searchResults.innerHTML = '<p class="no-results">No items found</p>';
              return;
            }
            
            data.items.forEach(item => {
              const itemElement = document.createElement('div');
              itemElement.className = 'search-item';
              itemElement.innerHTML = `
                <div class="item-details">
                  <span class="item-name">${item.name}</span>
                  ${item.artist_name ? `<span class="item-artist">by ${item.artist_name}</span>` : ''}
                </div>
              `;
              
              // Add click handler to add item to selected items
              itemElement.addEventListener('click', function() {
                // Check if already selected
                const isDuplicate = selectedItemsData.some(selectedItem => 
                  selectedItem.id === item.id && selectedItem.type === itemType
                );
                
                if (!isDuplicate) {
                  const newItem = {
                    id: item.id,
                    name: item.name,
                    artist_name: item.artist_name,
                    image_url: item.image_url,
                    type: itemType
                  };
                  
                  selectedItemsData.push(newItem);
                  updateSelectedItemsDisplay();
                }
                
                // Clear search field and results
                itemSearchInput.value = '';
                searchResults.innerHTML = '';
              });
              
              searchResults.appendChild(itemElement);
            });
          })
          .catch(error => {
            console.error('Error searching items:', error);
            searchResults.innerHTML = '<p class="error">Error searching items</p>';
          });
      });
      
      // Handle background option selection
      document.querySelectorAll('.bg-option').forEach(option => {
        option.addEventListener('click', function() {
          // Remove selected class from all options
          document.querySelectorAll('.bg-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          
          // Add selected class to clicked option
          this.classList.add('selected');
        });
      });
      
      // Generate chart when button is clicked
      generateButton.addEventListener('click', function() {
        generateChart();
      });
      
      // Randomize colors when button is clicked
      randomizeColorsButton.addEventListener('click', function() {
        randomizeChartColors();
      });
    }
    
    // Update selected items display
    function updateSelectedItemsDisplay() {
      if (selectedItemsData.length === 0) {
        selectedItems.innerHTML = '<p class="no-items">No items selected</p>';
        return;
      }
      
      selectedItems.innerHTML = '';
      
      selectedItemsData.forEach((item, index) => {
        const itemElement = document.createElement('div');
        itemElement.className = 'selected-item';
        itemElement.innerHTML = `
          <div class="item-details">
            <span class="item-name">${item.name}</span>
            ${item.artist_name ? `<span class="item-artist">by ${item.artist_name}</span>` : ''}
          </div>
          <button class="remove-item" data-index="${index}">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        selectedItems.appendChild(itemElement);
      });
      
      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          selectedItemsData.splice(index, 1);
          updateSelectedItemsDisplay();
        });
      });
    }
    
    // Generate chart
    function generateChart() {
      if (selectedItemsData.length === 0) {
        alert('Please select at least one item to include in the chart.');
        return;
      }
      
      const chartType = document.getElementById('chart-type').value;
      const timeGroup = document.getElementById('time-group').value;
      const timeRange = timeRangeSelect.value;
      let customStart = null;
      let customEnd = null;
      
      if (timeRange === 'custom') {
        customStart = document.getElementById('custom-start').value;
        customEnd = document.getElementById('custom-end').value;
        
        if (!customStart || !customEnd) {
          alert('Please select both start and end dates for custom range.');
          return;
        }
      }
      
      // Show loading state
      chartContainer.innerHTML = '';
      chartLoading.style.display = 'flex';
      
      // Prepare request data
      const requestData = {
        chart_type: chartType,
        time_group: timeGroup,
        time_range: timeRange,
        custom_start: customStart,
        custom_end: customEnd,
        items: selectedItemsData
      };
      
      // Send request to generate chart
      fetch('/api/generate_chart', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(requestData)
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(errorData => {
              throw new Error(errorData.error || 'Unknown error occurred');
            });
          }
          return response.json();
        })
        .then(data => {
          // Hide loading state
          chartLoading.style.display = 'none';
          
          // Create chart container
          chartContainer.innerHTML = `
            <div class="chart-canvas-container">
              <canvas id="analytics-chart"></canvas>
            </div>
            <div class="chart-actions">
              <button id="download-chart" class="chart-download-btn">
                <i class="fas fa-download"></i> Download Chart
              </button>
            </div>
          `;
          
          const ctx = document.getElementById('analytics-chart').getContext('2d');
          
          // Create chart title - only display for single item
          let chartTitle = '';
          if (selectedItemsData.length === 1) {
            chartTitle = selectedItemsData[0].name;
            if (selectedItemsData[0].artist_name) {
              chartTitle += ' - ' + selectedItemsData[0].artist_name;
            }
          }
          
          // Create the chart with Chart.js
          const chartConfig = {
            type: chartType === 'total' ? 'bar' : 'line',
            data: {
              labels: data.labels.map(label => {
                // Abbreviate month names or years
                if (timeGroup === 'month') {
                  // Convert month names to abbreviated versions (Jan, Feb, etc.)
                  const months = {
                    'January': 'Jan', 'February': 'Feb', 'March': 'Mar',
                    'April': 'Apr', 'May': 'May', 'June': 'Jun',
                    'July': 'Jul', 'August': 'Aug', 'September': 'Sep',
                    'October': 'Oct', 'November': 'Nov', 'December': 'Dec'
                  };
                  // Handle different possible month formats
                  for (const [full, abbr] of Object.entries(months)) {
                    if (label.includes(full)) {
                      return label.replace(full, abbr);
                    }
                  }
                  return label;
                } else if (timeGroup === 'year') {
                  // Format years as '24, '25, etc.
                  if (label.length === 4 && !isNaN(label)) {
                    return "'" + label.substring(2);
                  }
                }
                return label;
              }),
              datasets: data.datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              aspectRatio: 1.5, // Make chart taller
              plugins: {
                legend: {
                  position: 'top',
                  labels: {
                    boxWidth: 12, // Make legend color indicators smaller
                    boxHeight: 12,
                    padding: 10,
                    font: {
                      size: 12
                    }
                  }
                },
                title: {
                  display: true,
                  text: chartTitle,
                  font: {
                    size: 16,
                    weight: 'bold'
                  },
                  padding: {
                    top: 10,
                    bottom: 20
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(0,0,0,0.8)',
                  titleFont: {
                    weight: 'bold'
                  },
                  cornerRadius: 6,
                  padding: 10
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Streams',
                    font: {
                      weight: 'bold'
                    }
                  },
                  ticks: {
                    // Show fewer y-axis labels to make changes look more dramatic
                    maxTicksLimit: 5,
                    font: {
                      size: 11
                    }
                  },
                  // Make the y-axis scale more dramatic by suggesting a max that's close to the data
                  suggestedMax: function() {
                    // Find the maximum value in all datasets
                    let max = 0;
                    data.datasets.forEach(dataset => {
                      const dataMax = Math.max(...dataset.data.filter(val => val !== null));
                      if (dataMax > max) max = dataMax;
                    });
                    // Set y-axis max to be about 10% higher than the actual max
                    return max * 1.1;
                  }()
                },
                x: {
                  title: {
                    display: true,
                    text: timeGroup === 'month' ? 'Month' : 'Year',
                    font: {
                      weight: 'bold'
                    }
                  },
                  ticks: {
                    font: {
                      size: 11
                    }
                  }
                }
              },
              animation: {
                duration: 1000,
                easing: 'easeOutQuart'
              },
              layout: {
                padding: {
                  left: 10,
                  right: 20,
                  top: 0,
                  bottom: 10
                }
              }
            }
          };
          
          // For bar charts, make bars touch but not overlap
          if (chartType === 'total') {
            chartConfig.options.plugins.tooltip.callbacks = {
              label: function(context) {
                return `${context.dataset.label}: ${context.raw.toLocaleString()} streams`;
              }
            };
            chartConfig.options.scales.x.stacked = false; // Make sure bars aren't stacked
            chartConfig.options.barPercentage = 0.95; // Make bars nearly touch
            chartConfig.options.categoryPercentage = 0.95; // Make category bars take up more space
          } else {
            // For line charts, make lines more visually appealing
            chartConfig.options.elements = {
              line: {
                tension: 0.2, // Slight curve for lines
                borderWidth: 3  // Thicker lines
              },
              point: {
                radius: 4, // Slightly larger points
                hoverRadius: 6
              }
            };
          }
          
          // Create the chart and assign it to our chartInstance variable
          chartInstance = new Chart(ctx, chartConfig);
          
          // Add instruction text above the chart
          const chartCanvasContainer = document.querySelector('.chart-canvas-container');
          const instructionText = document.createElement('div');
          instructionText.className = 'chart-instruction';
          instructionText.innerHTML = '<i class="fas fa-info-circle"></i> Click legend items to show/hide';
          chartCanvasContainer.prepend(instructionText);
          
          // Update the colors panel
          populateColorPanel();
          
          // Add download button functionality
          document.getElementById('download-chart').addEventListener('click', function() {
            downloadChart();
          });
        })
        .catch(error => {
          console.error('Error generating chart:', error);
          chartLoading.style.display = 'none';
          chartContainer.innerHTML = '<p class="chart-error">Error generating chart: ' + error.message + '</p>';
        });
    }
    
    // Populate color panel with dataset colors
    function populateColorPanel() {
      // Check if chart exists
      if (!chartInstance) return;
      
      const datasetColorsContainer = document.getElementById('dataset-colors');
      datasetColorsContainer.innerHTML = ''; // Clear existing items
      
      // Create a color item for each dataset
      chartInstance.data.datasets.forEach((dataset, index) => {
        const color = dataset.borderColor || dataset.backgroundColor;
        
        const colorItem = document.createElement('div');
        colorItem.className = 'dataset-color-item';
        colorItem.innerHTML = `
          <div class="color-preview" style="background-color: ${color}" data-index="${index}"></div>
          <div class="color-label">${dataset.label}</div>
        `;
        
        datasetColorsContainer.appendChild(colorItem);
        
        // Add click event to the color preview
        const colorPreview = colorItem.querySelector('.color-preview');
        colorPreview.addEventListener('click', function() {
          const datasetIndex = parseInt(this.dataset.index);
          openColorPicker(datasetIndex, this);
        });
      });
    }
    
    // Open color picker when clicking on a color preview
    function openColorPicker(datasetIndex, colorElement) {
      // Check if chart exists
      if (!chartInstance) return;
      
      const dataset = chartInstance.data.datasets[datasetIndex];
      const currentColor = dataset.borderColor || dataset.backgroundColor;
      
      // Create color input
      const colorInput = document.createElement('input');
      colorInput.type = 'color';
      colorInput.value = currentColor;
      colorInput.style.opacity = 0;
      colorInput.style.position = 'absolute';
      colorInput.style.pointerEvents = 'none';
      document.body.appendChild(colorInput);
      
      // Handle color change
      colorInput.addEventListener('input', function() {
        const newColor = this.value;
        
        // Update preview immediately
        colorElement.style.backgroundColor = newColor;
        
        // Update chart
        if (chartInstance.config.type === 'line') {
          dataset.borderColor = newColor;
          dataset.backgroundColor = newColor + '33'; // Semi-transparent for fill
          dataset.pointBackgroundColor = newColor;
        } else {
          dataset.backgroundColor = newColor;
          dataset.borderColor = newColor;
        }
        
        chartInstance.update();
      });
      
      // Handle color selection complete
      colorInput.addEventListener('change', function() {
        // Remove the input when done
        document.body.removeChild(this);
      });
      
      // Open the color picker
      colorInput.click();
    }
    
    // Randomize chart colors
    function randomizeChartColors() {
      // Check if chart exists
      if (!chartInstance) {
        alert('Please generate a chart first.');
        return;
      }
      
      // Generate vibrant colors
      const vibrantColors = [
        '#4361ee', '#3a0ca3', '#7209b7', '#f72585', '#4cc9f0',
        '#ff9e00', '#38b000', '#ff006e', '#2b9348', '#f15bb5',
        '#0077b6', '#9d4edd', '#ef476f', '#fb8500', '#06d6a0',
        '#118ab2', '#073b4c', '#e76f51', '#d62828', '#5390d9'
      ];
      
      // Shuffle the colors array
      const shuffledColors = [...vibrantColors].sort(() => Math.random() - 0.5);
      
      // Apply new colors to datasets
      chartInstance.data.datasets.forEach((dataset, i) => {
        const newColor = shuffledColors[i % shuffledColors.length];
        
        if (chartInstance.config.type === 'line') {
          dataset.borderColor = newColor;
          dataset.backgroundColor = newColor + '33'; // Semi-transparent for fill
          dataset.pointBackgroundColor = newColor;
        } else {
          dataset.backgroundColor = newColor;
          dataset.borderColor = newColor;
        }
      });
      
      // Update chart
      chartInstance.update();
      
      // Refresh color panel
      populateColorPanel();
    }
    
    // Download chart with selected background
    function downloadChart() {
      // Check if chart exists
      if (!chartInstance) return;
      
      const selectedBg = document.querySelector('.bg-option.selected').dataset.bg;
      const chartWrapper = document.getElementById('chart-container');
      const canvas = document.getElementById('analytics-chart');
      
      // Store original styles
      const originalBg = chartWrapper.style.backgroundColor;
      const originalClass = chartWrapper.className;
      
      // Apply selected background
      if (selectedBg === 'light') {
        chartWrapper.style.backgroundColor = '#ffffff';
        chartWrapper.classList.remove('dark-mode');
      } else if (selectedBg === 'dark') {
        chartWrapper.style.backgroundColor = '#121212';
        chartWrapper.classList.add('dark-mode');
        
        // Update chart text colors for dark mode
        chartInstance.options.plugins.title.color = '#e0e0e0';
        chartInstance.options.scales.x.ticks.color = '#e0e0e0';
        chartInstance.options.scales.x.grid.color = 'rgba(255, 255, 255, 0.1)';
        chartInstance.options.scales.x.title.color = '#e0e0e0';
        chartInstance.options.scales.y.ticks.color = '#e0e0e0';
        chartInstance.options.scales.y.grid.color = 'rgba(255, 255, 255, 0.1)';
        chartInstance.options.scales.y.title.color = '#e0e0e0';
      } else if (selectedBg === 'gradient') {
        chartWrapper.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        chartWrapper.classList.add('dark-mode');
        
        // Update chart text colors for dark mode
        chartInstance.options.plugins.title.color = '#ffffff';
        chartInstance.options.scales.x.ticks.color = '#ffffff';
        chartInstance.options.scales.x.grid.color = 'rgba(255, 255, 255, 0.2)';
        chartInstance.options.scales.x.title.color = '#ffffff';
        chartInstance.options.scales.y.ticks.color = '#ffffff';
        chartInstance.options.scales.y.grid.color = 'rgba(255, 255, 255, 0.2)';
        chartInstance.options.scales.y.title.color = '#ffffff';
      } else if (selectedBg === 'blue') {
        chartWrapper.style.backgroundColor = '#EFF6FF';
        chartWrapper.classList.remove('dark-mode');
        
        // Update chart text colors for blue theme
        chartInstance.options.plugins.title.color = '#1E40AF';
        chartInstance.options.scales.x.ticks.color = '#1E40AF';
        chartInstance.options.scales.x.grid.color = 'rgba(30, 64, 175, 0.1)';
        chartInstance.options.scales.x.title.color = '#1E40AF';
        chartInstance.options.scales.y.ticks.color = '#1E40AF';
        chartInstance.options.scales.y.grid.color = 'rgba(30, 64, 175, 0.1)';
        chartInstance.options.scales.y.title.color = '#1E40AF';
      }
      
      // Update chart
      chartInstance.update();
      
      // Allow time for the chart to update before capturing
      setTimeout(() => {
        // Create watermarked canvas for download
        const downloadCanvas = document.createElement('canvas');
        const downloadCtx = downloadCanvas.getContext('2d');
        
        // Set dimensions
        downloadCanvas.width = canvas.width;
        downloadCanvas.height = canvas.height;
        
        // Draw the chart
        downloadCtx.drawImage(canvas, 0, 0);
        
        // Add watermark
        downloadCtx.font = '12px Arial';
        downloadCtx.fillStyle = selectedBg === 'dark' || selectedBg === 'gradient' ? 'rgba(255, 255, 255, 0.5)' : 'rgba(0, 0, 0, 0.3)';
        downloadCtx.textAlign = 'end';
        downloadCtx.fillText('musicmuse.io', canvas.width - 10, canvas.height - 10);
        
        // Create download link
        const link = document.createElement('a');
        link.download = 'musicmuse-chart.png';
        link.href = downloadCanvas.toDataURL('image/png');
        link.click();
        
        // Restore original styles
        chartWrapper.style.backgroundColor = originalBg;
        chartWrapper.style.background = '';
        chartWrapper.className = originalClass;
        
        // Reset chart text colors
        const defaultTextColor = '#666666';
        const defaultGridColor = 'rgba(0, 0, 0, 0.1)';
        
        chartInstance.options.plugins.title.color = defaultTextColor;
        chartInstance.options.scales.x.ticks.color = defaultTextColor;
        chartInstance.options.scales.x.grid.color = defaultGridColor;
        chartInstance.options.scales.x.title.color = defaultTextColor;
        chartInstance.options.scales.y.ticks.color = defaultTextColor;
        chartInstance.options.scales.y.grid.color = defaultGridColor;
        chartInstance.options.scales.y.title.color = defaultTextColor;
        
        // Update chart to restore original appearance
        chartInstance.update();
      }, 100);
    }
  });
</script>
{% endblock %}
