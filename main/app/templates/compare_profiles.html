{% extends "base.html" %}

{% block header_title %}Profile Comparison{% endblock %}

{% block content %}
<h2 class="music-question-header"><em class="emphasis-word">Compare</em> your listening history with friends.</h2>
<div class="comparison-container" data-is-comparing="{{ 'true' if comparing else 'false' }}">
  <!-- Comparison header with time filter -->
  <div class="comparison-header">
    {% if comparing %}
    <div class="comparison-nav">
      <a href="javascript:history.back()" class="back-button" title="Go back to selection page">
        <i class="fas fa-arrow-left"></i>
      </a>
    </div>
    {% endif %}
    <form method="POST" action="{{ url_for('social.compare_profiles') }}" class="filter-form">
      {% if comparing %}
      <input type="hidden" name="username1" value="{{ user1_name }}">
      <input type="hidden" name="username2" value="{{ user2_name }}">
      {% else %}
      <div class="user-selection-row">
        <select name="username1" id="username1" class="searchable-select" required placeholder="User">
          <option value="">User</option>
          {% if session.get('username') %}
            <option value="{{ session.get('username') }}" data-is-current-user="true">{{ session.get('username') }} (You)</option>
          {% endif %}
          {% for user in all_users %}
            {% if user.username != session.get('username') %}
              <option value="{{ user.username }}" {% if all_users|length > friends|length and user.user_id not in friends|map(attribute='user_id')|list %}data-search-only="true"{% endif %}>{{ user.username }}</option>
            {% endif %}
          {% endfor %}
        </select>
        
        <select name="username2" id="username2" class="searchable-select" required placeholder="User">
          <option value="">User</option>
          {% if session.get('username') %}
            <option value="{{ session.get('username') }}" data-is-current-user="true">{{ session.get('username') }} (You)</option>
          {% endif %}
          {% for user in all_users %}
            {% if user.username != session.get('username') %}
              <option value="{{ user.username }}" {% if all_users|length > friends|length and user.user_id not in friends|map(attribute='user_id')|list %}data-search-only="true"{% endif %}>{{ user.username }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      {% endif %}
      
      <div class="time-range-group">
        <label for="time_range">Time Range:</label>
        <select name="time_range" id="time_range" onchange="toggleCustomDateFields()" class="time-range-select">
          <option value="all_time" {% if time_range == "all_time" %}selected{% endif %}>All Time</option>
          <option value="this_week" {% if time_range == "this_week" %}selected{% endif %}>This Week</option>
          <option value="this_month" {% if time_range == "this_month" %}selected{% endif %}>Last 30 Days</option>
          <option value="this_year" {% if time_range == "this_year" %}selected{% endif %}>This Year</option>
          <option value="year_2024" {% if time_range == "year_2024" %}selected{% endif %}>2024</option>
          <option value="year_2023" {% if time_range == "year_2023" %}selected{% endif %}>2023</option>
          <option value="custom" {% if time_range == "custom" %}selected{% endif %}>Custom Range</option>
        </select>
      </div>
      
      <div id="custom-date-fields" class="custom-date-fields" {% if time_range != "custom" %}style="display: none;"{% endif %}>
        <div class="date-field">
          <label for="custom_start">From:</label>
          <input type="date" id="custom_start" name="custom_start" value="{{ custom_start if custom_start else '' }}">
        </div>
        <div class="date-field">
          <label for="custom_end">To:</label>
          <input type="date" id="custom_end" name="custom_end" value="{{ custom_end if custom_end else '' }}">
        </div>
      </div>
      
      <button type="submit" class="filter-button">Apply</button>
    </form>
  </div>
  
  <!-- Core metrics comparison -->
  {% if comparing %}
  <div class="metrics-comparison">
    
    <table class="comparison-table">
      <thead>
        <tr>
          <th class="time-range-title">{{ time_range_display|default('All Time') }} Listening</th>
          <th>{{ user1_name }}</th>
          <th>{{ user2_name }}</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="metric-label">Total Streams</td>
          <td class="metric-value {% if metrics.stats and metrics.stats[0] > metrics.stats[5] %}highlight{% endif %}">
            {{ metrics.stats[0] if metrics.stats else 0 }}
          </td>
          <td class="metric-value {% if metrics.stats and metrics.stats[5] > metrics.stats[0] %}highlight{% endif %}">
            {{ metrics.stats[5] if metrics.stats else 0 }}
          </td>
        </tr>
        <tr>
          <td class="metric-label">Listening Time</td>
          <td class="metric-value {% if metrics.stats and metrics.stats[2] > metrics.stats[7] %}highlight{% endif %}">
            {{ (metrics.stats[2] / 3600000)|round|int if metrics.stats else 0 }} hrs
          </td>
          <td class="metric-value {% if metrics.stats and metrics.stats[7] > metrics.stats[2] %}highlight{% endif %}">
            {{ (metrics.stats[7] / 3600000)|round|int if metrics.stats else 0 }} hrs
          </td>
        </tr>
        <tr>
          <td class="metric-label">Unique Tracks</td>
          <td class="metric-value {% if metrics.stats and metrics.stats[1] > metrics.stats[6] %}highlight{% endif %}">
            {{ metrics.stats[1] if metrics.stats else 0 }}
          </td>
          <td class="metric-value {% if metrics.stats and metrics.stats[6] > metrics.stats[1] %}highlight{% endif %}">
            {{ metrics.stats[6] if metrics.stats else 0 }}
          </td>
        </tr>
        <tr>
          <td class="metric-label">Unique Albums</td>
          <td class="metric-value {% if metrics.stats and metrics.stats[3] > metrics.stats[8] %}highlight{% endif %}">
            {{ metrics.stats[3] if metrics.stats else 0 }}
          </td>
          <td class="metric-value {% if metrics.stats and metrics.stats[8] > metrics.stats[3] %}highlight{% endif %}">
            {{ metrics.stats[8] if metrics.stats else 0 }}
          </td>
        </tr>
        <tr>
          <td class="metric-label">Unique Artists</td>
          <td class="metric-value {% if metrics.stats and metrics.stats[4] > metrics.stats[9] %}highlight{% endif %}">
            {{ metrics.stats[4] if metrics.stats else 0 }}
          </td>
          <td class="metric-value {% if metrics.stats and metrics.stats[9] > metrics.stats[4] %}highlight{% endif %}">
            {{ metrics.stats[9] if metrics.stats else 0 }}
          </td>
        </tr>
      </tbody>
    </table>
    
    <div class="comparison-footer">
      <p>musicmuse</p>
    </div>
  </div>
  {% endif %}
  
  <!-- Export options -->
  {% if comparing %}
  <div class="export-options">
    <button id="share-button" class="export-button">
      <i class="fas fa-share-alt"></i> Share Comparison
    </button>
    <button id="download-pdf" class="export-button">
      <i class="fas fa-file-pdf"></i> Download as PDF
    </button>
  </div>
  {% endif %}
</div>

<!-- Hidden div for PDF generation -->
{% if comparing %}
<div id="pdf-content" style="display: none; position: absolute; left: -9999px;">
  <div class="pdf-container" style="width: 800px; padding: 20px; font-family: Arial, sans-serif; background-color: white;">
    <!-- Table layout as requested -->
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
      <thead>
        <tr>
          <th style="width: 40%; text-align: left; padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">{{ time_range_display|default('All Time') }} Listening</th>
          <th style="width: 30%; text-align: center; padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">{{ user1_name }}</th>
          <th style="width: 30%; text-align: center; padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">{{ user2_name }}</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: left; padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Total Streams</td>
          <td class="data-cell {{ 'highlight' if metrics.stats and metrics.stats[0] > metrics.stats[5] else '' }}" style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">
            {{ metrics.stats[0] if metrics.stats else 0 }}
          </td>
          <td class="data-cell {{ 'highlight' if metrics.stats and metrics.stats[5] > metrics.stats[0] else '' }}" style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">
            {{ metrics.stats[5] if metrics.stats else 0 }}
          </td>
        </tr>
        <tr>
          <td style="text-align: left; padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Listening Time</td>
          <td class="data-cell {{ 'highlight' if metrics.stats and metrics.stats[2] > metrics.stats[7] else '' }}" style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">
            {{ (metrics.stats[2] / 3600000)|round|int if metrics.stats else 0 }} hrs
          </td>
          <td class="data-cell {{ 'highlight' if metrics.stats and metrics.stats[7] > metrics.stats[2] else '' }}" style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">
            {{ (metrics.stats[7] / 3600000)|round|int if metrics.stats else 0 }} hrs
          </td>
        </tr>
        <tr>
          <td style="text-align: left; padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Unique Tracks</td>
          <td class="data-cell {{ 'highlight' if metrics.stats and metrics.stats[1] > metrics.stats[6] else '' }}" style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">
            {{ metrics.stats[1] if metrics.stats else 0 }}
          </td>
          <td class="data-cell {{ 'highlight' if metrics.stats and metrics.stats[6] > metrics.stats[1] else '' }}" style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">
            {{ metrics.stats[6] if metrics.stats else 0 }}
          </td>
        </tr>
        <tr>
          <td style="text-align: left; padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Unique Albums</td>
          <td class="data-cell {{ 'highlight' if metrics.stats and metrics.stats[3] > metrics.stats[8] else '' }}" style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">
            {{ metrics.stats[3] if metrics.stats else 0 }}
          </td>
          <td class="data-cell {{ 'highlight' if metrics.stats and metrics.stats[8] > metrics.stats[3] else '' }}" style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">
            {{ metrics.stats[8] if metrics.stats else 0 }}
          </td>
        </tr>
        <tr>
          <td style="text-align: left; padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">Unique Artists</td>
          <td class="data-cell {{ 'highlight' if metrics.stats and metrics.stats[4] > metrics.stats[9] else '' }}" style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">
            {{ metrics.stats[4] if metrics.stats else 0 }}
          </td>
          <td class="data-cell {{ 'highlight' if metrics.stats and metrics.stats[9] > metrics.stats[4] else '' }}" style="text-align: center; padding: 10px; border-bottom: 1px solid #ddd;">
            {{ metrics.stats[9] if metrics.stats else 0 }}
          </td>
        </tr>
      </tbody>
    </table>
    
    <!-- Footer with app name -->
    <div style="text-align: center; font-weight: bold; font-size: 14px; color: #333;">
      musicmuse
    </div>
  </div>
</div>
{% endif %}

<!-- Add necessary libraries for PDF generation and Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* Form layout */
  .comparison-container {
    max-width: 800px;
    margin: 0 auto;
  }
  
  .comparison-header {
    margin-bottom: 20px;
  }
  
  .filter-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  /* Back button styling */
  .comparison-nav {
    margin-bottom: 15px;
  }
  
  .back-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #f0f2f5;
    color: #333;
    text-decoration: none;
    transition: background-color 0.2s;
  }
  
  .back-button:hover {
    background-color: #e4e6e9;
  }
  
  .back-button i {
    font-size: 16px;
  }
  
  /* User selection styling */
  .user-selection-row {
    display: flex;
    gap: 15px;
    margin-bottom: 10px;
  }
  
  .user-selection-row .searchable-select {
    flex: 1;
  }
  
  /* Select2 custom styling - improved for smoother experience */
  .select2-container {
    min-height: 38px;
    position: relative;
  }
  
  .select2-container--default .select2-selection--single {
    border-radius: 4px;
    border: 1px solid #ced4da;
    height: 38px;
    display: flex;
    align-items: center;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    background-color: #fff;
  }
  
  .select2-container--default .select2-selection--single:focus,
  .select2-container--default.select2-container--focus .select2-selection--single {
    border-color: #a5b3f7;
    box-shadow: 0 0 0 0.2rem rgba(92, 107, 192, 0.25);
    outline: 0;
  }
  
  .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #495057;
    line-height: 38px;
    padding-left: 12px;
  }
  
  .select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
    width: 30px;
  }
  
  .select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: #6c757d;
  }
  
  /* Fixed dropdown styling */
  .select2-dropdown {
    border: 1px solid #ced4da;
    border-radius: 4px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    overflow: hidden;
    z-index: 9999; /* Higher z-index to ensure visibility */
    background-color: white;
  }
  
  /* Improved search field styling */
  .select2-search--dropdown {
    padding: 10px;
    position: sticky;
    top: 0;
    background-color: white;
    z-index: 1;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .select2-container--default .select2-search--dropdown .select2-search__field {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 8px 12px;
    height: 38px;
    width: 100% !important;
    font-size: 14px;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
  }
  
  .select2-container--default .select2-search--dropdown .select2-search__field:focus {
    border-color: #a5b3f7;
    outline: 0;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.075), 0 0 0 0.2rem rgba(92, 107, 192, 0.25);
  }
  
  .select2-results {
    padding: 4px 0;
    max-height: 250px;
  }
  
  .select2-container--default .select2-results__option {
    padding: 10px 12px;
    transition: background-color 0.15s ease;
    font-size: 14px;
  }
  
  .select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #5c6bc0;
    color: white;
  }
  
  .select2-container--default .select2-results__option[data-is-current-user="true"] {
    font-weight: bold;
    background-color: #f0f4ff;
  }
  
  /* Ensure the dropdown stays open */
  .select2-container--open {
    z-index: 9999;
  }
  
  /* Time range styling */
  .time-range-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .time-range-select {
    width: auto !important;
    min-width: 120px;
    max-width: 150px;
    height: 38px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 0 8px;
  }
  
  /* Custom date fields */
  .custom-date-fields {
    display: flex;
    gap: 15px;
  }
  
  .date-field {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .date-field input {
    height: 38px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 0 8px;
  }
  
  /* Button styling */
  .filter-button {
    align-self: flex-end;
    padding: 8px 16px;
    background-color: #5c6bc0;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  
  .filter-button:hover {
    background-color: #4a59b5;
  }
  
  /* Comparison table styling */
  .comparison-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    background-color: white;
  }
  
  .comparison-table th,
  .comparison-table td {
    padding: 12px 15px;
    text-align: center;
    border-bottom: 1px solid #eee;
  }
  
  .comparison-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #333;
  }
  
  .comparison-table th:first-child {
    text-align: left;
  }
  
  .comparison-table td:first-child {
    text-align: left;
    font-weight: bold;
    color: #444;
  }
  
  .comparison-table .highlight {
    color: #5c6bc0;
    font-weight: bold;
  }
  
  .time-range-title {
    font-size: 1.1em;
    color: #333;
  }
  
  .comparison-footer {
    text-align: center;
    margin-top: 20px;
    font-weight: bold;
    color: #666;
  }
  
  /* Export options */
  .export-options {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }
  
  .export-button {
    padding: 8px 16px;
    background-color: #5c6bc0;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  
  .export-button:hover {
    background-color: #4a59b5;
  }
  
  /* Header styling */
  .music-question-header {
    text-align: center;
    margin-bottom: 20px;
    color: #000;
    font-weight: 600;
    font-size: 1.5rem;
  }

  .music-question-header .emphasis-word {
    color: #6a5acd;
  }
  
  /* Responsive adjustments */
  @media (max-width: 600px) {
    .user-selection-row {
      flex-direction: column;
    }
    
    .time-range-group {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .custom-date-fields {
      flex-direction: column;
    }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  function toggleCustomDateFields() {
    const timeRange = document.getElementById('time_range');
    const customDateFields = document.getElementById('custom-date-fields');
    
    if (timeRange && customDateFields) {
      if (timeRange.value === 'custom') {
        customDateFields.style.display = 'flex';
      } else {
        customDateFields.style.display = 'none';
      }
    }
  }
  
  $(document).ready(function() {
    // Get comparing state from data attribute
    const comparisonContainer = $('.comparison-container');
    const isComparing = comparisonContainer.data('is-comparing') === 'true';
    
    // Initialize Select2 for searchable dropdowns if not comparing yet
    if (!isComparing) {
      // Configure Select2 with improved settings for smoother experience
      $('.searchable-select').select2({
        placeholder: function() {
          return $(this).attr('placeholder');
        },
        allowClear: true,
        minimumResultsForSearch: 0, // Always show search
        width: '100%',
        dropdownParent: $('body'), // Attach to body to prevent layout shifts
        closeOnSelect: true,
        theme: 'default',
        language: {
          searching: function() {
            return "Searching...";
          },
          noResults: function() {
            return "No users found";
          }
        },
        // Custom matcher to show search-only users only when searching
        matcher: function(params, data) {
          // Always show friends and the current user
          if (!data.element || !$(data.element).data('search-only')) {
            return $.fn.select2.defaults.defaults.matcher(params, data);
          }
          
          // If no search term and this is a search-only user, hide it
          if (!params.term) {
            return null;
          }
          
          // Otherwise use the default matcher
          return $.fn.select2.defaults.defaults.matcher(params, data);
        },
        templateResult: function(option) {
          if (!option.id) {
            return option.text;
          }
          
          const $option = $(option.element);
          const isCurrentUser = $option.data('is-current-user');
          
          if (isCurrentUser) {
            return $('<span><strong>' + option.text + '</strong></span>');
          }
          
          return option.text;
        }
      });
      
      // Improved dropdown positioning and stability
      $('.searchable-select').on('select2:open', function() {
        // Focus the search field immediately
        setTimeout(function() {
          $('.select2-search__field').focus();
          
          // Ensure the dropdown is properly positioned and sized
          const dropdown = $('.select2-dropdown');
          const select = $('.select2-container--open');
          
          // Match dropdown width to the select container
          dropdown.css({
            'width': select.width() + 'px',
            'min-width': '220px'
          });
          
          // Add a class to the body to prevent scrolling if needed
          $('body').addClass('select2-open');
        }, 0);
      });
      
      // Handle dropdown closing
      $('.searchable-select').on('select2:closing', function(e) {
        // Remove body class when dropdown closes
        $('body').removeClass('select2-open');
      });
      
      // Prevent dropdown from closing when clicking inside the search field
      $(document).on('click', '.select2-search__field', function(e) {
        e.stopPropagation();
      });
      
      // Prevent selecting the same user twice
      const username1Select = $('#username1');
      const username2Select = $('#username2');
      
      username1Select.on('change', function() {
        const selectedUser = $(this).val();
        
        // Enable all options in user2
        username2Select.find('option').prop('disabled', false);
        
        // Disable the option that matches user1's selection in user2
        if (selectedUser) {
          username2Select.find('option[value="' + selectedUser + '"]').prop('disabled', true);
        }
        
        // If user2 has the same value as user1, reset user2
        if (username2Select.val() === selectedUser) {
          username2Select.val('').trigger('change');
        }
        
        // Refresh Select2 to reflect the changes WITHOUT destroying and re-creating it
        // This preserves the search functionality
        username2Select.select2('destroy');
        username2Select.select2({
          placeholder: 'User',
          allowClear: true,
          minimumResultsForSearch: 0,
          width: '100%',
          dropdownParent: $('body'),
          closeOnSelect: true,
          theme: 'default',
          language: {
            searching: function() {
              return "Searching...";
            },
            noResults: function() {
              return "No users found";
            }
          },
          matcher: function(params, data) {
            // Check if option is disabled first
            if ($(data.element).prop('disabled')) {
              return null;
            }
            
            // Always show friends and the current user
            if (!data.element || !$(data.element).data('search-only')) {
              return $.fn.select2.defaults.defaults.matcher(params, data);
            }
            
            // If no search term and this is a search-only user, hide it
            if (!params.term) {
              return null;
            }
            
            // Otherwise use the default matcher
            return $.fn.select2.defaults.defaults.matcher(params, data);
          },
          templateResult: function(option) {
            if (!option.id) {
              return option.text;
            }
            
            const $option = $(option.element);
            const isCurrentUser = $option.data('is-current-user');
            
            if (isCurrentUser) {
              return $('<span><strong>' + option.text + '</strong></span>');
            }
            
            return option.text;
          }
        });
      });
      
      username2Select.on('change', function() {
        const selectedUser = $(this).val();
        
        // Enable all options in user1
        username1Select.find('option').prop('disabled', false);
        
        // Disable the option that matches user2's selection in user1
        if (selectedUser) {
          username1Select.find('option[value="' + selectedUser + '"]').prop('disabled', true);
        }
        
        // If user1 has the same value as user2, reset user1
        if (username1Select.val() === selectedUser) {
          username1Select.val('').trigger('change');
        }
        
        // Refresh Select2 to reflect the changes WITHOUT destroying and re-creating it
        // This preserves the search functionality
        username1Select.select2('destroy');
        username1Select.select2({
          placeholder: 'User',
          allowClear: true,
          minimumResultsForSearch: 0,
          width: '100%',
          dropdownParent: $('body'),
          closeOnSelect: true,
          theme: 'default',
          language: {
            searching: function() {
              return "Searching...";
            },
            noResults: function() {
              return "No users found";
            }
          },
          matcher: function(params, data) {
            // Check if option is disabled first
            if ($(data.element).prop('disabled')) {
              return null;
            }
            
            // Always show friends and the current user
            if (!data.element || !$(data.element).data('search-only')) {
              return $.fn.select2.defaults.defaults.matcher(params, data);
            }
            
            // If no search term and this is a search-only user, hide it
            if (!params.term) {
              return null;
            }
            
            // Otherwise use the default matcher
            return $.fn.select2.defaults.defaults.matcher(params, data);
          },
          templateResult: function(option) {
            if (!option.id) {
              return option.text;
            }
            
            const $option = $(option.element);
            const isCurrentUser = $option.data('is-current-user');
            
            if (isCurrentUser) {
              return $('<span><strong>' + option.text + '</strong></span>');
            }
            
            return option.text;
          }
        });
      });
      
      // Add keyboard navigation support
      $(document).on('keydown', '.select2-search__field', function(e) {
        // Prevent dropdown from closing on Tab
        if (e.key === 'Tab') {
          e.stopPropagation();
        }
      });
    }
    
    // Share button functionality
    const shareButton = $('#share-button');
    if (shareButton.length) {
      shareButton.on('click', function() {
        // Create a shareable URL
        const url = window.location.href;
        
        // Check if the browser supports the Web Share API
        if (navigator.share) {
          navigator.share({
            title: '{{ user1_name }} vs {{ user2_name }} - Music Muse Comparison',
            text: 'Check out this music taste comparison between {{ user1_name }} and {{ user2_name }}!',
            url: url
          })
          .catch(error => console.log('Error sharing:', error));
        } else {
          // Fallback to copying the URL
          navigator.clipboard.writeText(url)
            .then(() => {
              alert('Comparison URL copied to clipboard!');
            })
            .catch(err => {
              console.error('Failed to copy URL: ', err);
            });
        }
      });
    }
    
    // PDF download functionality
    const downloadPdfButton = $('#download-pdf');
    const pdfContent = $('#pdf-content');
    const timeRangeSelect = $('#time_range');
    
    if (downloadPdfButton.length && pdfContent.length && timeRangeSelect.length) {
      downloadPdfButton.on('click', function() {
        // Make it visible for html2canvas
        pdfContent.css({
          'display': 'block',
          'position': 'absolute',
          'left': '-9999px'
        });
        
        // Use html2canvas and jsPDF to generate the PDF
        window.html2canvas(pdfContent[0], {
          scale: 2, // Higher scale for better quality
          logging: false,
          useCORS: true
        }).then(canvas => {
          // Hide the PDF content element again
          pdfContent.css('display', 'none');
          
          // Create PDF using jsPDF
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'pt', 'a4');
          
          // Calculate dimensions to fit the canvas on the PDF
          const imgWidth = 595; // A4 width in points
          const imgHeight = canvas.height * imgWidth / canvas.width;
          
          // Add the canvas as an image to the PDF
          const imgData = canvas.toDataURL('image/png');
          pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
          
          // Save the PDF
          pdf.save('{{ user1_name }}_vs_{{ user2_name }}_comparison.pdf');
        });
      });
    }
  });
</script>
{% endblock %}