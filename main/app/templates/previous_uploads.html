{% extends "base.html" %}

{% block header_title %}Previous Uploads{% endblock %}

{% block content %}
<div class="previous-uploads-container">
  <div class="previous-uploads-header">
    <h2>Your Previous Uploads</h2>
    <p>Here's a list of your previously uploaded streaming data files.</p>
  </div>
  
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash-messages">
        {% for message in messages %}
          <div class="flash-message">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  
  <div class="uploads-list">
    {% if uploads %}
      <div class="uploads-actions">
        <button id="refresh-uploads" class="refresh-button">
          <i class="fas fa-sync-alt"></i> Refresh Status
        </button>
      </div>
      
      <table class="uploads-table">
        <thead>
          <tr>
            <th>File Name</th>
            <th>File Size</th>
            <th>Status</th>
            <th>Upload Date</th>
          </tr>
        </thead>
        <tbody id="uploads-tbody">
          {% for upload in uploads %}
            <tr data-upload-id="{{ upload.upload_id }}">
              <td>{{ upload.file_name }}</td>
              <td>{{ upload.file_size }}</td>
              <td><span class="status-badge status-{{ upload.status|lower }}">{{ upload.status }}</span></td>
              <td>{{ upload.created_at }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="uploads-count">
        <p>Showing <span id="upload-count">{{ uploads|length }}</span> uploaded file(s)</p>
      </div>
    {% else %}
      <div class="no-uploads">
        <p>You haven't uploaded any streaming data files yet.</p>
      </div>
    {% endif %}
  </div>
  
  <div class="upload-actions">
    <a href="{{ url_for('profile.upload_streaming_data') }}" class="button">
      <i class="fas fa-upload"></i> Upload New Data
    </a>
    <a href="{{ url_for('profile.user_settings') }}" class="button secondary">
      <i class="fas fa-arrow-left"></i> Back to Settings
    </a>
  </div>
</div>

<style>
  .previous-uploads-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .previous-uploads-header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .previous-uploads-header h2 {
    font-size: 1.8em;
    color: #333;
    margin-bottom: 10px;
  }
  
  .uploads-list {
    margin-bottom: 30px;
  }
  
  .uploads-actions {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 15px;
  }
  
  .refresh-button {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    background-color: #f0f2f5;
    color: #555;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9em;
  }
  
  .refresh-button:hover {
    background-color: #e0e0e0;
    color: #333;
  }
  
  .refresh-button i {
    margin-right: 6px;
  }
  
  .refresh-button.refreshing i {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  .uploads-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  
  .uploads-table th, .uploads-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }
  
  .uploads-table th {
    background-color: #5c6bc0;
    color: white;
  }
  
  .uploads-table tr:hover {
    background-color: #f5f5f5;
  }
  
  /* Status badge styling */
  .status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 500;
  }
  
  .status-processed {
    background-color: #4caf50;
    color: white;
  }
  
  .status-processing {
    background-color: #ff9800;
    color: white;
  }
  
  .status-pending {
    background-color: #9e9e9e;
    color: white;
  }
  
  .uploads-count {
    text-align: right;
    font-size: 0.9em;
    color: #666;
    margin-top: 10px;
  }
  
  .no-uploads {
    text-align: center;
    padding: 30px;
    background-color: #f9f9f9;
    border-radius: 8px;
  }
  
  .upload-actions {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
  }
  
  .button {
    display: inline-flex;
    align-items: center;
    padding: 10px 20px;
    background-color: #5c6bc0;
    color: white;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 500;
    transition: background-color 0.3s;
  }
  
  .button:hover {
    background-color: #3f51b5;
  }
  
  .button.secondary {
    background-color: #757575;
  }
  
  .button.secondary:hover {
    background-color: #616161;
  }
  
  .button i {
    margin-right: 8px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const refreshButton = document.getElementById('refresh-uploads');
    
    if (refreshButton) {
      refreshButton.addEventListener('click', function() {
        // Add spinning animation to refresh icon
        this.classList.add('refreshing');
        
        // Fetch updated upload statuses
        fetch('{{ url_for("profile.check_upload_status") }}', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateUploadTable(data.uploads);
          } else {
            alert(data.message || 'Error refreshing upload status');
          }
        })
        .catch(error => {
          console.error('Error refreshing uploads:', error);
          alert('An error occurred while refreshing upload status. Please try again.');
        })
        .finally(() => {
          // Remove spinning animation
          refreshButton.classList.remove('refreshing');
        });
      });
    }
    
    function updateUploadTable(uploads) {
      const tbody = document.getElementById('uploads-tbody');
      const countElement = document.getElementById('upload-count');
      
      if (!tbody) return;
      
      // Clear the current table content
      tbody.innerHTML = '';
      
      // Add the updated uploads
      uploads.forEach(upload => {
        const row = document.createElement('tr');
        row.setAttribute('data-upload-id', upload.upload_id);
        
        row.innerHTML = `
          <td>${upload.file_name}</td>
          <td>${upload.file_size}</td>
          <td><span class="status-badge status-${upload.status.toLowerCase()}">${upload.status}</span></td>
          <td>${upload.created_at}</td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Update the count
      if (countElement) {
        countElement.textContent = uploads.length;
      }
    }
  });
</script>
{% endblock %} 