{% extends "base.html" %}

{% block header_title %}{% endblock %}

{% block content %}
  <h2 class="music-question-header"><em class="emphasis-word">Browse</em> through your listening history.</h2>
  <div class="filter-container">
    <form method="GET" class="filter-form">
      <div class="filter-group">
        <label for="type"><i class="fas fa-list"></i></label>
        <select name="type" id="type">
          <option value="tracks" {% if selected_type == "tracks" %}selected{% endif %}>Tracks</option>
          <option value="albums" {% if selected_type == "albums" %}selected{% endif %}>Albums</option>
          <option value="artists" {% if selected_type == "artists" %}selected{% endif %}>Artists</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="time_range"><i class="fas fa-calendar-alt"></i></label>
        <select name="time_range" id="time_range" onchange="toggleCustomDateFields()">
          <option value="all_time" {% if selected_range == "all_time" %}selected{% endif %}>All Time</option>
          <option value="this_week" {% if selected_range == "this_week" %}selected{% endif %}>Last 7 Days</option>
          <option value="this_month" {% if selected_range == "this_month" %}selected{% endif %}>Last 30 Days</option>
          <option value="this_year" {% if selected_range == "this_year" %}selected{% endif %}>This Year</option>
          <option value="year_2024" {% if selected_range == "year_2024" %}selected{% endif %}>2024</option>
          <option value="year_2023" {% if selected_range == "year_2023" %}selected{% endif %}>2023</option>
          
          <option value="custom" {% if selected_range == "custom" %}selected{% endif %}>Custom Range</option>
        </select>
      </div>
      
      <div id="custom-date-fields" class="custom-date-fields" {% if selected_range != "custom" %}style="display: none;"{% endif %}>
        <div class="date-field">
          <label for="custom_start">From:</label>
          <input type="date" id="custom_start" name="custom_start" value="{{ custom_start if custom_start else '' }}">
        </div>
        <div class="date-field">
          <label for="custom_end">To:</label>
          <input type="date" id="custom_end" name="custom_end" value="{{ custom_end if custom_end else '' }}">
        </div>
      </div>
      
      <div class="filter-group">
        <label for="time_unit"><i class="fas fa-clock"></i></label>
        <select name="time_unit" id="time_unit">
          <option value="hours" {% if time_unit == "hours" %}selected{% endif %}>Hours</option>
          <option value="minutes" {% if time_unit == "minutes" %}selected{% endif %}>Minutes</option>
        </select>
      </div>
      
      <button type="submit" class="filter-button">Apply</button>
    </form>
  </div>

  <table id="items-table">
    <thead>
      <tr>
        <th class="image-column"></th>
        {% if selected_type == "tracks" %}
          <th>Track</th>
          <th>Artist</th>
        {% elif selected_type == "albums" %}
          <th>Album</th>
          <th>Artist</th>
        {% else %}
          <th>Artist</th>
        {% endif %}
        <th>Total Streams</th>
        <th>Total {{ "Hours" if time_unit == "hours" else "Minutes" }}</th>
      </tr>
    </thead>
    <tbody id="items-container">
      {% for row in rows %}
        <tr>
          {% if selected_type == "tracks" %}
            <td class="image-column">
              <a href="{{ url_for('item_pages.album_page', album_id=row[5] if row|length > 5 else 0) }}">
                <div class="item-thumbnail" style="background-image: url('{{ row[4] if row|length > 4 and row[4] else url_for('static', filename='img/default-album.png') }}')"></div>
              </a>
            </td>
            <td>
              <a href="{{ url_for('item_pages.track_page', track_id=row[6] if row|length > 6 else 0) }}" class="item-link">
                {{ row[0] }}
              </a>
            </td>
            <td>
              <a href="{{ url_for('item_pages.artist_page', artist_id=row[7] if row|length > 7 else 0) }}" class="item-link">
                {{ row[1] }}
              </a>
            </td>
            <td>{{ row[2] }}</td>
            <td>{{ row[3] }}</td>
          {% elif selected_type == "albums" %}
            <td class="image-column">
              <a href="{{ url_for('item_pages.album_page', album_id=row[5] if row|length > 5 else 0) }}">
                <div class="item-thumbnail" style="background-image: url('{{ row[4] if row|length > 4 and row[4] else url_for('static', filename='img/default-album.png') }}')"></div>
              </a>
            </td>
            <td>
              <a href="{{ url_for('item_pages.album_page', album_id=row[5] if row|length > 5 else 0) }}" class="item-link">
                {{ row[0] }}
              </a>
            </td>
            <td>
              <a href="{{ url_for('item_pages.artist_page', artist_id=row[6] if row|length > 6 else 0) }}" class="item-link">
                {{ row[1] }}
              </a>
            </td>
            <td>{{ row[2] }}</td>
            <td>{{ row[3] }}</td>
          {% else %}
            <td class="image-column">
              <a href="{{ url_for('item_pages.artist_page', artist_id=row[4] if row|length > 4 else 0) }}">
                <div class="item-thumbnail" style="background-image: url('{{ row[3] if row|length > 3 and row[3] else url_for('static', filename='img/default-artist.png') }}')"></div>
              </a>
            </td>
            <td>
              <a href="{{ url_for('item_pages.artist_page', artist_id=row[4] if row|length > 4 else 0) }}" class="item-link">
                {{ row[0] }}
              </a>
            </td>
            <td>{{ row[1] }}</td>
            <td>{{ row[2] }}</td>
          {% endif %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div id="loading-more" class="loading-more" style="display: none;">
    <div class="spinner"></div>
    <p>Loading more items...</p>
  </div>

  <script>
    function toggleCustomDateFields() {
      const timeRange = document.getElementById('time_range').value;
      const customDateFields = document.getElementById('custom-date-fields');
      
      if (timeRange === 'custom') {
        customDateFields.style.display = 'flex';
      } else {
        customDateFields.style.display = 'none';
      }
    }
    
    // Set initial state on page load
    document.addEventListener('DOMContentLoaded', toggleCustomDateFields);

    // Infinite scrolling functionality
    document.addEventListener('DOMContentLoaded', function() {
      let page = 1;
      let loading = false;
      const loadingIndicator = document.getElementById('loading-more');
      const itemsContainer = document.getElementById('items-container');
      
      function loadMoreItems() {
        if (loading) return;
        
        loading = true;
        if (loadingIndicator) {
          loadingIndicator.style.display = 'flex';
        }
        
        // Get current filter parameters and preserve them in the request
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('page', page + 1);
        urlParams.set('format', 'json');
        
        // Make sure we have the current type parameter 
        if (!urlParams.has('type')) {
          urlParams.set('type', '{{ selected_type }}');
        }
        
        // Make sure we have the current time_range parameter
        if (!urlParams.has('time_range')) {
          urlParams.set('time_range', '{{ selected_range }}');
        }
        
        // Define complete URL patterns for item pages
        const artistUrlBase = "{{ url_for('item_pages.artist_page', artist_id=0) }}";
        const albumUrlBase = "{{ url_for('item_pages.album_page', album_id=0) }}";
        const trackUrlBase = "{{ url_for('item_pages.track_page', track_id=0) }}";
        
        // Function to replace ID in URL
        function getItemUrl(baseUrl, itemId) {
          return baseUrl.replace('/0', '/' + itemId);
        }
        
        fetch(`${window.location.pathname}?${urlParams.toString()}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.items && data.items.length > 0) {
              // Append new items to the table
              data.items.forEach(row => {
                const tr = document.createElement('tr');
                
                if (data.type === 'tracks') {
                  const defaultImg = '{{ url_for("static", filename="img/default-album.png") }}';
                  const albumId = row.length > 5 ? row[5] : 0;
                  const trackId = row.length > 6 ? row[6] : 0;
                  const artistId = row.length > 7 ? row[7] : 0;
                  
                  tr.innerHTML = `
                    <td class="image-column">
                      <a href="${getItemUrl(albumUrlBase, albumId)}">
                        <div class="item-thumbnail" style="background-image: url('${row[4] || defaultImg}')"></div>
                      </a>
                    </td>
                    <td>
                      <a href="${getItemUrl(trackUrlBase, trackId)}" class="item-link">${row[0]}</a>
                    </td>
                    <td>
                      <a href="${getItemUrl(artistUrlBase, artistId)}" class="item-link">${row[1]}</a>
                    </td>
                    <td>${row[2]}</td>
                    <td>${row[3]}</td>
                  `;
                } else if (data.type === 'albums') {
                  const defaultImg = '{{ url_for("static", filename="img/default-album.png") }}';
                  const albumId = row.length > 5 ? row[5] : 0;
                  const artistId = row.length > 6 ? row[6] : 0;
                  
                  tr.innerHTML = `
                    <td class="image-column">
                      <a href="${getItemUrl(albumUrlBase, albumId)}">
                        <div class="item-thumbnail" style="background-image: url('${row[4] || defaultImg}')"></div>
                      </a>
                    </td>
                    <td>
                      <a href="${getItemUrl(albumUrlBase, albumId)}" class="item-link">${row[0]}</a>
                    </td>
                    <td>
                      <a href="${getItemUrl(artistUrlBase, artistId)}" class="item-link">${row[1]}</a>
                    </td>
                    <td>${row[2]}</td>
                    <td>${row[3]}</td>
                  `;
                } else { // artists
                  const defaultImg = '{{ url_for("static", filename="img/default-artist.png") }}';
                  const artistId = row.length > 4 ? row[4] : 0;
                  
                  tr.innerHTML = `
                    <td class="image-column">
                      <a href="${getItemUrl(artistUrlBase, artistId)}">
                        <div class="item-thumbnail" style="background-image: url('${row[3] || defaultImg}')"></div>
                      </a>
                    </td>
                    <td>
                      <a href="${getItemUrl(artistUrlBase, artistId)}" class="item-link">${row[0]}</a>
                    </td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                  `;
                }
                
                if (itemsContainer) {
                  itemsContainer.appendChild(tr);
                }
              });
              
              page++;
              loading = false;
            } else {
              console.log("No more items to load");
            }
            
            if (loadingIndicator) {
              loadingIndicator.style.display = 'none';
            }
          })
          .catch(error => {
            console.error('Error loading more items:', error);
            loading = false;
            if (loadingIndicator) {
              loadingIndicator.style.display = 'none';
            }
          });
      }
      
      // Detect when user scrolls to bottom of the page
      window.addEventListener('scroll', function() {
        const scrollPosition = window.scrollY + window.innerHeight;
        const pageHeight = document.documentElement.scrollHeight;
        
        // Load more when user is near the bottom (200px threshold)
        if (scrollPosition >= pageHeight - 200 && !loading) {
          loadMoreItems();
        }
      });
    });
  </script>

  <style>
    .music-question-header {
      text-align: center;
      margin-bottom: 20px;
      color: #000;
      font-weight: 600;
      font-size: 1.5rem;
    }

    .music-question-header .emphasis-word {
      color: #6a5acd;
    }
  </style>
{% endblock %} 