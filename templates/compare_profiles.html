{% extends "base.html" %}

{% block header_title %}Profile Comparison{% endblock %}

{% block content %}
<div class="comparison-container">
  <!-- Comparison header with user info and time filter -->
  <div class="comparison-header">
    <div class="user-headers">
      <div class="user-header">{{ user1 }}</div>
      <div class="vs">VS</div>
      <div class="user-header">{{ user2 }}</div>
    </div>
    
    <div class="time-filter">
      <form method="GET" action="{{ url_for('compare_profiles') }}" class="filter-form">
        <input type="hidden" name="user1" value="{{ user1 }}">
        <input type="hidden" name="user2" value="{{ user2 }}">
        
        <div class="filter-group">
          <label for="time_range">Time Range:</label>
          <select name="time_range" id="time_range" onchange="toggleCustomDateFields()">
            <option value="all_time" {% if selected_range == "all_time" %}selected{% endif %}>All Time</option>
            <option value="this_week" {% if selected_range == "this_week" %}selected{% endif %}>This Week</option>
            <option value="this_month" {% if selected_range == "this_month" %}selected{% endif %}>Last 30 Days</option>
            <option value="this_year" {% if selected_range == "this_year" %}selected{% endif %}>This Year</option>
            <option value="year_2024" {% if selected_range == "year_2024" %}selected{% endif %}>2024</option>
            <option value="year_2023" {% if selected_range == "year_2023" %}selected{% endif %}>2023</option>
            <option value="custom" {% if selected_range == "custom" %}selected{% endif %}>Custom Range</option>
          </select>
        </div>
        
        <div id="custom-date-fields" class="custom-date-fields" {% if selected_range != "custom" %}style="display: none;"{% endif %}>
          <div class="date-field">
            <label for="custom_start">From:</label>
            <input type="date" id="custom_start" name="custom_start" value="{{ custom_start if custom_start else '' }}">
          </div>
          <div class="date-field">
            <label for="custom_end">To:</label>
            <input type="date" id="custom_end" name="custom_end" value="{{ custom_end if custom_end else '' }}">
          </div>
        </div>
        
        <button type="submit" class="filter-button">Apply Filter</button>
      </form>
    </div>
  </div>
  
  <!-- Core metrics comparison -->
  <div class="metrics-comparison">
    <h3>Listening Stats</h3>
    
    <div class="metric-row">
      <div class="metric-label">Total Streams</div>
      <div class="metric-value {% if metrics.total_streams_1 > metrics.total_streams_2 %}highlight{% endif %}">
        {{ metrics.total_streams_1 }}
      </div>
      <div class="metric-value {% if metrics.total_streams_2 > metrics.total_streams_1 %}highlight{% endif %}">
        {{ metrics.total_streams_2 }}
      </div>
    </div>
    
    <div class="metric-row">
      <div class="metric-label">Listening Time (hrs)</div>
      <div class="metric-value {% if metrics.total_hours_1 > metrics.total_hours_2 %}highlight{% endif %}">
        {{ metrics.total_hours_1 }}
      </div>
      <div class="metric-value {% if metrics.total_hours_2 > metrics.total_hours_1 %}highlight{% endif %}">
        {{ metrics.total_hours_2 }}
      </div>
    </div>
    
    <div class="metric-row">
      <div class="metric-label">Unique Tracks</div>
      <div class="metric-value {% if metrics.unique_tracks_1 > metrics.unique_tracks_2 %}highlight{% endif %}">
        {{ metrics.unique_tracks_1 }}
      </div>
      <div class="metric-value {% if metrics.unique_tracks_2 > metrics.unique_tracks_1 %}highlight{% endif %}">
        {{ metrics.unique_tracks_2 }}
      </div>
    </div>
    
    <div class="metric-row">
      <div class="metric-label">Unique Albums</div>
      <div class="metric-value {% if metrics.unique_albums_1 > metrics.unique_albums_2 %}highlight{% endif %}">
        {{ metrics.unique_albums_1 }}
      </div>
      <div class="metric-value {% if metrics.unique_albums_2 > metrics.unique_albums_1 %}highlight{% endif %}">
        {{ metrics.unique_albums_2 }}
      </div>
    </div>
    
    <div class="metric-row">
      <div class="metric-label">Unique Artists</div>
      <div class="metric-value {% if metrics.unique_artists_1 > metrics.unique_artists_2 %}highlight{% endif %}">
        {{ metrics.unique_artists_1 }}
      </div>
      <div class="metric-value {% if metrics.unique_artists_2 > metrics.unique_artists_1 %}highlight{% endif %}">
        {{ metrics.unique_artists_2 }}
      </div>
    </div>
    
    <div class="metric-row">
      <div class="metric-label">Obscurity Score</div>
      <div class="metric-value {% if metrics.obscurity_score_1 > metrics.obscurity_score_2 %}highlight{% endif %}">
        {{ metrics.obscurity_score_1 }}%
      </div>
      <div class="metric-value {% if metrics.obscurity_score_2 > metrics.obscurity_score_1 %}highlight{% endif %}">
        {{ metrics.obscurity_score_2 }}%
      </div>
    </div>
  </div>
  
  <!-- Export options -->
  <div class="export-options">
    <button id="share-button" class="export-button">
      <i class="fas fa-share-alt"></i> Share Comparison
    </button>
    <button id="download-pdf" class="export-button">
      <i class="fas fa-file-pdf"></i> Download as PDF
    </button>
  </div>
</div>

<script>
  function toggleCustomDateFields() {
    const timeRange = document.getElementById('time_range').value;
    const customDateFields = document.getElementById('custom-date-fields');
    
    if (timeRange === 'custom') {
      customDateFields.style.display = 'flex';
    } else {
      customDateFields.style.display = 'none';
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    // Share button functionality
    document.getElementById('share-button').addEventListener('click', function() {
      // Create a shareable URL
      const url = window.location.href;
      
      // Check if the browser supports the Web Share API
      if (navigator.share) {
        navigator.share({
          title: '{{ user1 }} vs {{ user2 }} - Music Muse Comparison',
          text: 'Check out this music taste comparison between {{ user1 }} and {{ user2 }}!',
          url: url
        })
        .catch(error => console.log('Error sharing:', error));
      } else {
        // Fallback to copying the URL
        navigator.clipboard.writeText(url)
          .then(() => {
            alert('Comparison URL copied to clipboard!');
          })
          .catch(err => {
            console.error('Failed to copy URL: ', err);
          });
      }
    });
    
    // PDF download functionality (placeholder)
    document.getElementById('download-pdf').addEventListener('click', function() {
      alert('PDF download functionality will be implemented soon.');
    });
  });
</script>
{% endblock %}