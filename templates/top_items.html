{% extends "base.html" %}

{% block header_title %}Top {{ selected_type|capitalize }}{% endblock %}

{% block content %}
  <div class="filter-container">
    <form method="GET" class="filter-form">
      <div class="filter-group">
        <label for="type"><i class="fas fa-list"></i></label>
        <select name="type" id="type">
          <option value="tracks" {% if selected_type == "tracks" %}selected{% endif %}>Tracks</option>
          <option value="albums" {% if selected_type == "albums" %}selected{% endif %}>Albums</option>
          <option value="artists" {% if selected_type == "artists" %}selected{% endif %}>Artists</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="time_range"><i class="fas fa-calendar-alt"></i></label>
        <select name="time_range" id="time_range" onchange="toggleCustomDateFields()">
          <option value="all_time" {% if selected_range == "all_time" %}selected{% endif %}>All Time</option>
          <option value="this_week" {% if selected_range == "this_week" %}selected{% endif %}>Last 7 Days</option>
          <option value="this_month" {% if selected_range == "this_month" %}selected{% endif %}>Last 30 Days</option>
          <option value="this_year" {% if selected_range == "this_year" %}selected{% endif %}>This Year</option>
          <option value="year_2024" {% if selected_range == "year_2024" %}selected{% endif %}>2024</option>
          <option value="year_2023" {% if selected_range == "year_2023" %}selected{% endif %}>2023</option>
          
          <option value="custom" {% if selected_range == "custom" %}selected{% endif %}>Custom Range</option>
        </select>
      </div>
      
      <div id="custom-date-fields" class="custom-date-fields" {% if selected_range != "custom" %}style="display: none;"{% endif %}>
        <div class="date-field">
          <label for="custom_start">From:</label>
          <input type="date" id="custom_start" name="custom_start" value="{{ custom_start if custom_start else '' }}">
        </div>
        <div class="date-field">
          <label for="custom_end">To:</label>
          <input type="date" id="custom_end" name="custom_end" value="{{ custom_end if custom_end else '' }}">
        </div>
      </div>
      
      <div class="filter-group">
        <label for="time_unit"><i class="fas fa-clock"></i></label>
        <select name="time_unit" id="time_unit">
          <option value="hours" {% if time_unit == "hours" %}selected{% endif %}>Hours</option>
          <option value="minutes" {% if time_unit == "minutes" %}selected{% endif %}>Minutes</option>
        </select>
      </div>
      
      <button type="submit" class="filter-button">Apply</button>
    </form>
  </div>

  <table id="items-table">
    <thead>
      <tr>
        {% if selected_type == "tracks" %}
          <th>Track</th>
          <th>Artist</th>
        {% elif selected_type == "albums" %}
          <th>Album</th>
          <th>Artist</th>
        {% else %}
          <th>Artist</th>
        {% endif %}
        <th>Total Streams</th>
        <th>Total {{ "Hours" if time_unit == "hours" else "Minutes" }}</th>
      </tr>
    </thead>
    <tbody id="items-container">
      {% for row in rows %}
        <tr>
          {% if selected_type == "tracks" %}
            <td>{{ row[0] }}</td>
            <td>{{ row[1] }}</td>
            <td>{{ row[2] }}</td>
            <td>{{ row[3] }}</td>
          {% elif selected_type == "albums" %}
            <td>{{ row[0] }}</td>
            <td>{{ row[1] }}</td>
            <td>{{ row[2] }}</td>
            <td>{{ row[3] }}</td>
          {% else %}
            <td>{{ row[0] }}</td>
            <td>{{ row[1] }}</td>
            <td>{{ row[2] }}</td>
          {% endif %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div id="loading-more" class="loading-more" style="display: none;">
    <div class="spinner"></div>
    <p>Loading more items...</p>
  </div>

  <script>
    function toggleCustomDateFields() {
      const timeRange = document.getElementById('time_range').value;
      const customDateFields = document.getElementById('custom-date-fields');
      
      if (timeRange === 'custom') {
        customDateFields.style.display = 'flex';
      } else {
        customDateFields.style.display = 'none';
      }
    }
    
    // Set initial state on page load
    document.addEventListener('DOMContentLoaded', toggleCustomDateFields);

    // Infinite scrolling functionality
    document.addEventListener('DOMContentLoaded', function() {
      let page = 1;
      let loading = false;
      const loadingIndicator = document.getElementById('loading-more');
      const itemsContainer = document.getElementById('items-container');
      
      function loadMoreItems() {
        if (loading) return;
        
        loading = true;
        loadingIndicator.style.display = 'flex';
        
        // Get current filter parameters
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('page', page + 1);
        urlParams.set('format', 'json');
        
        fetch(`${window.location.pathname}?${urlParams.toString()}`)
          .then(response => response.json())
          .then(data => {
            if (data.items && data.items.length > 0) {
              // Append new items to the table
              data.items.forEach(row => {
                const tr = document.createElement('tr');
                
                if (data.type === 'tracks' || data.type === 'albums') {
                  tr.innerHTML = `
                    <td>${row[0]}</td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                    <td>${row[3]}</td>
                  `;
                } else {
                  tr.innerHTML = `
                    <td>${row[0]}</td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                  `;
                }
                
                itemsContainer.appendChild(tr);
              });
              
              page++;
              loading = false;
            }
            
            loadingIndicator.style.display = 'none';
          })
          .catch(error => {
            console.error('Error loading more items:', error);
            loading = false;
            loadingIndicator.style.display = 'none';
          });
      }
      
      // Detect when user scrolls to bottom of the page
      window.addEventListener('scroll', function() {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
          loadMoreItems();
        }
      });
    });
  </script>
{% endblock %} 