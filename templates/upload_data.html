{% extends "base.html" %}

{% block header_title %}Upload Streaming Data{% endblock %}

{% block content %}
<div class="upload-data-container">
  <div class="upload-data-header">
    <h2>Upload Your Streaming History</h2>
    <p>Upload your streaming history files to see personalized insights and statistics.</p>
  </div>
  
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash-messages">
        {% for message in messages %}
          <div class="flash-message">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  
  <div class="upload-instructions">
    <h3>How to get your streaming data:</h3>
    <ol>
      <li>Go to your Spotify account page</li>
      <li>Navigate to Privacy settings</li>
      <li>Request your data (this may take a few days)</li>
      <li>Download the ZIP file when available</li>
      <li>Extract the ZIP file</li>
      <li>Upload the JSON files containing your streaming history</li>
    </ol>
  </div>
  
  <form method="POST" action="{{ url_for('upload_streaming_data') }}" enctype="multipart/form-data" class="upload-form">
    <div class="upload-area">
      <div class="upload-icon">
        <i class="fas fa-cloud-upload-alt"></i>
      </div>
      <p>Drag and drop files here or click to browse</p>
      <input type="file" id="streaming_data" name="streaming_data" accept=".json" multiple>
    </div>
    
    <div id="selected-files" class="selected-files"></div>
    
    <button type="submit" class="upload-button">Upload and Process Data</button>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('streaming_data');
    const selectedFilesContainer = document.getElementById('selected-files');
    const uploadArea = document.querySelector('.upload-area');
    
    // Handle file selection
    fileInput.addEventListener('change', function() {
      selectedFilesContainer.innerHTML = '';
      
      if (this.files.length > 0) {
        for (let i = 0; i < this.files.length; i++) {
          const file = this.files[i];
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <div class="file-icon"><i class="fas fa-file-alt"></i></div>
            <div class="file-info">
              <div class="file-name">${file.name}</div>
              <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
          `;
          selectedFilesContainer.appendChild(fileItem);
        }
      }
    });
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function() {
      this.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      
      fileInput.files = e.dataTransfer.files;
      const event = new Event('change');
      fileInput.dispatchEvent(event);
    });
    
    uploadArea.addEventListener('click', function() {
      fileInput.click();
    });
    
    // Format file size
    function formatFileSize(bytes) {
      if (bytes < 1024) {
        return bytes + ' bytes';
      } else if (bytes < 1024 * 1024) {
        return (bytes / 1024).toFixed(1) + ' KB';
      } else {
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
    }
  });
</script>
{% endblock %}