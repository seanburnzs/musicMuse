{% extends "base.html" %}

{% block header_title %}{% endblock %}

{% block content %}
<div class="profile-container">
  <!-- Navigation header -->
  <div class="profile-header">
    <a href="javascript:history.back()" class="back-button">
      <i class="fas fa-arrow-left"></i>
    </a>
    <h2 class="profile-username">{{ username }}</h2>
    
    {% if session.get('user_id') and username != session.get('username') %}
      <div class="follow-container">
        {% if is_following %}
          <form method="POST" action="{{ url_for('unfollow_user', username=username) }}">
            <button type="submit" class="unfollow-button">
              <i class="fas fa-user-minus"></i> Unfollow
            </button>
          </form>
        {% else %}
          <form method="POST" action="{{ url_for('follow_user', username=username) }}">
            <button type="submit" class="follow-button">
              <i class="fas fa-user-plus"></i> Follow
            </button>
          </form>
        {% endif %}
      </div>
    {% else %}
      <div class="profile-menu">
        <div class="dropdown">
          <button class="dropdown-toggle">
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <div class="dropdown-menu">
            {% if session.get('user_id') and username == session.get('username') %}
              <a href="{{ url_for('user_settings') }}" class="dropdown-item">Settings</a>
              <a href="{{ url_for('customize_hall_of_fame') }}" class="dropdown-item">Edit H.O.F.</a>
            {% endif %}
            <a href="#" class="dropdown-item" id="copy-url">Copy URL</a>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Profile stats -->
  <div class="profile-stats">
    <div class="stat-item">
      <div class="stat-value">{{ total_streams }}</div>
      <div class="stat-label">Streams</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ followers_count }}</div>
      <div class="stat-label">Followers</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ following_count }}</div>
      <div class="stat-label">Following</div>
    </div>
  </div>

  <!-- Profile grid -->
  <div class="profile-grid">
    <!-- Hall of Fame section -->
    <div class="profile-section hall-of-fame">
      <div class="section-header">
        <h3>Hall of Fame <span class="section-subtitle">All-time favorites</span></h3>
        {% if session.get('user_id') and username == session.get('username') %}
          <a href="{{ url_for('customize_hall_of_fame') }}" class="edit-hof-button">
            <i class="fas fa-edit"></i> Edit
          </a>
        {% endif %}
      </div>
      
      <!-- Top Artists -->
      <div class="item-category">
        <h4>Top Artists</h4>
        <div class="item-row">
          {% for artist_id, artist_name, image_url, total_streams, total_hours in hall_of_fame.artists %}
            <div class="profile-item">
              <div class="item-image" style="background-image: url('{{ image_url if image_url else url_for('static', filename='img/default-artist.png') }}')"></div>
              <div class="item-details">
                <div class="item-name">{{ artist_name }}</div>
                <div class="item-stats">{{ total_streams }} streams • {{ total_hours }} hrs</div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      
      <!-- Top Albums -->
      <div class="item-category">
        <h4>Top Albums</h4>
        <div class="item-row">
          {% for album_id, album_name, artist_name, image_url, total_streams, total_hours in hall_of_fame.albums %}
            <div class="profile-item">
              <div class="item-image" style="background-image: url('{{ image_url if image_url else url_for('static', filename='img/default-album.png') }}')"></div>
              <div class="item-details">
                <div class="item-name">{{ album_name }}</div>
                <div class="item-artist">{{ artist_name }}</div>
                <div class="item-stats">{{ total_streams }} streams • {{ total_hours }} hrs</div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      
      <!-- Top Tracks -->
      <div class="item-category">
        <h4>Top Tracks</h4>
        <div class="item-row">
          {% for track_id, track_name, artist_name, image_url, total_streams, total_hours in hall_of_fame.tracks %}
            <div class="profile-item">
              <div class="item-image" style="background-image: url('{{ image_url if image_url else url_for('static', filename='img/default-album.png') }}')"></div>
              <div class="item-details">
                <div class="item-name">{{ track_name }}</div>
                <div class="item-artist">{{ artist_name }}</div>
                <div class="item-stats">{{ total_streams }} streams • {{ total_hours }} hrs</div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    
    <!-- Recents section (formerly Showcase) -->
    <div class="profile-section recents">
      <h3>Recents <span class="section-subtitle">Last 30 days</span></h3>
      
      <!-- Current Top Artists -->
      <div class="item-category">
        <h4>Current Artists</h4>
        <div class="item-row">
          {% for artist_id, artist_name, image_url, total_streams, total_hours in recents.artists %}
            <div class="profile-item">
              <div class="item-image" style="background-image: url('{{ image_url if image_url else url_for('static', filename='img/default-artist.png') }}')"></div>
              <div class="item-details">
                <div class="item-name">{{ artist_name }}</div>
                <div class="item-stats">{{ total_streams }} streams • {{ total_hours }} hrs</div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      
      <!-- Current Top Albums -->
      <div class="item-category">
        <h4>Current Albums</h4>
        <div class="item-row">
          {% for album_id, album_name, artist_name, image_url, total_streams, total_hours in recents.albums %}
            <div class="profile-item">
              <div class="item-image" style="background-image: url('{{ image_url if image_url else url_for('static', filename='img/default-album.png') }}')"></div>
              <div class="item-details">
                <div class="item-name">{{ album_name }}</div>
                <div class="item-artist">{{ artist_name }}</div>
                <div class="item-stats">{{ total_streams }} streams • {{ total_hours }} hrs</div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      
      <!-- Current Top Tracks -->
      <div class="item-category">
        <h4>Current Tracks</h4>
        <div class="item-row">
          {% for track_id, track_name, artist_name, image_url, total_streams, total_hours in recents.tracks %}
            <div class="profile-item">
              <div class="item-image" style="background-image: url('{{ image_url if image_url else url_for('static', filename='img/default-album.png') }}')"></div>
              <div class="item-details">
                <div class="item-name">{{ track_name }}</div>
                <div class="item-artist">{{ artist_name }}</div>
                <div class="item-stats">{{ total_streams }} streams • {{ total_hours }} hrs</div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    
    <!-- Life Events section -->
    <div class="profile-section events">
      <div class="section-header">
        <h3>Life Events</h3>
        {% if username == session.get('impersonating', {}).get('username') or not session.get('impersonating') and username == session.get('username') %}
          <a href="{{ url_for('new_event') }}" class="add-event-button">
            <i class="fas fa-plus"></i> Add Event
          </a>
        {% endif %}
      </div>
      
      {% if events_visible %}
        <div class="events-list">
          {% if events %}
            {% for event_id, name, start_date, end_date, description, category, color in events %}
              <div class="event-card" style="border-left-color: {{ color }}">
                <div class="event-header">
                  <h4 class="event-name">{{ name }}</h4>
                  <div class="event-actions">
                    <span class="event-category">{{ category }}</span>
                    {% if username == session.get('impersonating', {}).get('username') or not session.get('impersonating') and username == session.get('username') %}
                      <div class="event-menu">
                        <button class="event-menu-toggle">
                          <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="event-menu-dropdown">
                          <a href="{{ url_for('edit_event', event_id=event_id) }}" class="event-menu-item">
                            <i class="fas fa-edit"></i> Edit
                          </a>
                          <button class="event-menu-item delete-event" data-event-id="{{ event_id }}">
                            <i class="fas fa-trash"></i> Delete
                          </button>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                </div>
                <div class="event-dates">
                  {{ start_date.strftime('%b %d, %Y') }} - 
                  {% if end_date %}
                    {{ end_date.strftime('%b %d, %Y') }}
                  {% else %}
                    Present
                  {% endif %}
                </div>
                {% if description %}
                  <div class="event-description">{{ description }}</div>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div class="no-events">No life events shared</div>
          {% endif %}
        </div>
      {% else %}
        <div class="events-private">
          <div class="lock-icon">
            <i class="fas fa-lock"></i>
          </div>
          <p>This user's life events are private</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Dropdown menu functionality
    const dropdownToggle = document.querySelector('.dropdown-toggle');
    const dropdownMenu = document.querySelector('.dropdown-menu');
    
    if (dropdownToggle) {
      dropdownToggle.addEventListener('click', function() {
        dropdownMenu.classList.toggle('show');
      });
      
      // Close dropdown when clicking outside
      window.addEventListener('click', function(event) {
        if (!event.target.matches('.dropdown-toggle') && !event.target.matches('.fa-ellipsis-v')) {
          if (dropdownMenu.classList.contains('show')) {
            dropdownMenu.classList.remove('show');
          }
        }
      });
    }
    
    // Copy URL functionality
    const copyUrlButton = document.getElementById('copy-url');
    if (copyUrlButton) {
      copyUrlButton.addEventListener('click', function(e) {
        e.preventDefault();
        navigator.clipboard.writeText(window.location.href)
          .then(() => {
            alert('Profile URL copied to clipboard!');
          })
          .catch(err => {
            console.error('Failed to copy URL: ', err);
          });
      });
    }
    
    // Event menu toggle functionality
    const eventMenuToggles = document.querySelectorAll('.event-menu-toggle');
    
    eventMenuToggles.forEach(toggle => {
      toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        const dropdown = this.nextElementSibling;
        dropdown.classList.toggle('show');
      });
    });
    
    // Close event menus when clicking outside
    window.addEventListener('click', function(event) {
      if (!event.target.matches('.event-menu-toggle') && !event.target.matches('.fa-ellipsis-v')) {
        const dropdowns = document.querySelectorAll('.event-menu-dropdown');
        dropdowns.forEach(dropdown => {
          if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        });
      }
    });
    
    // Delete event functionality
    const deleteButtons = document.querySelectorAll('.delete-event');
    
    deleteButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        const eventId = this.getAttribute('data-event-id');
        
        if (confirm('Are you sure you want to delete this event?')) {
          // Create and submit a form to delete the event
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/events/delete/' + eventId;
          document.body.appendChild(form);
          form.submit();
        }
      });
    });
  });
</script>
{% endblock %}